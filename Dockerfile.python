# Dockerfile –¥–ª—è Python –±–æ—Ç–æ–≤
FROM python:3.11-slim

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    gcc \
    sqlite3 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ requirements.txt –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt certifi

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ Python
COPY *.py ./

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
RUN mkdir -p player_cards player_photos task_submissions

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# –°–æ–∑–¥–∞–Ω–∏–µ non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN useradd -m -u 1001 -s /bin/bash botuser && \
    chown -R botuser:botuser /app

USER botuser

# –°–æ–∑–¥–∞–Ω–∏–µ entrypoint —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±–æ–∏—Ö –±–æ—Ç–æ–≤
COPY --chown=botuser:botuser <<EOF /app/start-bots.sh
#!/bin/bash
set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Motivation Bot —Å–µ—Ä–≤–∏—Å–æ–≤..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è graceful shutdown
cleanup() {
    echo ""
    echo "üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    kill -TERM \$BOT_PID \$MODERATOR_PID 2>/dev/null || true
    wait \$BOT_PID \$MODERATOR_PID
    echo "‚úÖ –í—Å–µ –±–æ—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

trap cleanup SIGTERM SIGINT

# –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Node.js —Å–µ—Ä–≤–∏—Å–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Node.js —Å–µ—Ä–≤–∏—Å–∞..."
for i in {1..30}; do
    if curl -f http://card-generator:3000/health >/dev/null 2>&1; then
        echo "‚úÖ Node.js —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω"
        break
    fi
    echo "–ü–æ–ø—ã—Ç–∫–∞ \$i/30..."
    sleep 2
done

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
python bot.py &
BOT_PID=\$!
echo "üéØ –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: \$BOT_PID)"

# –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
sleep 2

# –ó–∞–ø—É—Å–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–æ–≥–æ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
python moderator_bot.py &
MODERATOR_PID=\$!
echo "‚öîÔ∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: \$MODERATOR_PID)"

echo ""
echo "‚úÖ –í—Å–µ Python –±–æ—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo "üìã PID –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
echo "  ‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç: \$BOT_PID"
echo "  ‚Ä¢ –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–π –±–æ—Ç: \$MODERATOR_PID"
echo ""
echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
wait \$BOT_PID \$MODERATOR_PID
EOF

RUN chmod +x /app/start-bots.sh

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["/app/start-bots.sh"]
